# Notion Page Viewer PHP

This is a simple PHP project designed to fetch content from a specific Notion page (and its direct child pages) and display it as a website. It utilizes the official Notion API and includes features like server-side caching, basic block rendering, URL routing, dynamic meta tags, and robot blocking.

## Features

*   **Notion Content Display**: Renders content from a specified Notion page.
*   **Subpage Routing**: Automatically creates routes for direct child pages and **multi-level nested subpages** of the main Notion page (e.g., `yourdomain.com/parent-slug/child-slug`). The URL path is generated by normalizing the page titles and reflects the content hierarchy.
*   **Block Support**: Handles common Notion blocks (headings, paragraphs, lists, todos, toggles, images, videos, audio, files, embeds, bookmarks, code, equations, quotes, callouts, dividers, tables, table of contents, breadcrumb, child pages). Blocks support background colors.
*   **Cover Images**: Displays page cover images in full-width format above the content.
*   **Lazy Loading**: Images use native browser lazy loading (`loading="lazy"`) for improved page performance.
*   **Image Proxy**: All Notion images are served through a local proxy (`image.php`) with 7-day server-side cache. This solves the issue of Notion's expiring image URLs (~1 hour) and improves loading performance.
*   **Rich Text Formatting**: Supports standard Notion formatting (bold, italics, strikethrough, underline, code, colors) and links. Mentions supported: page, date, user, database.
*   **Server-Side Caching**: Caches Notion API responses to improve performance. Cache durations are now configurable granularly for different types of data (content, page metadata, subpage lists, page mentions) via the `$cacheDurations` array in `private/config.php`. This allows for optimized refresh rates based on how frequently different data types are expected to change. The old `$cacheExpiration` variable still exists and defaults to the 'content' cache duration but primary control is through the new array.
*   **Dynamic Page Titles & Meta Tags**:
    *   Uses the actual Notion page title for the HTML `<title>` tag and the main `<h1>` header.
    *   Generates dynamic `<meta name="description">` based on the page title.
    *   Generates dynamic Open Graph meta tags (`og:title`, `og:description`, `og:url`, `og:type`) for better social media sharing previews. `og:title` combines main page and subpage titles appropriately.
*   **Security Headers**: Implements comprehensive security headers via `security_headers.php`:
    *   Content Security Policy (CSP)
    *   X-Content-Type-Options: nosniff
    *   X-Frame-Options: DENY
    *   X-XSS-Protection: 1; mode=block
    *   Strict-Transport-Security (HSTS)
*   **SEO & Robot Control**:
    *   Includes `<meta name="robots" content="noindex, nofollow">` to instruct standard search engines not to index the site.
    *   Includes a `robots.txt` file to block standard crawlers and specific AI crawlers (`Google-Extended`, `GPTBot`, `ChatGPT-User`, `CCBot`, `ClaudeBot`, etc.) from accessing the site.
*   **JavaScript Enhancements**:
    *   Table of Contents - renders in place of Notion's `table_of_contents` block, or auto-generates if many headings.
    *   Simple lightbox effect for images.
*   **Content Hiding**: Allows hiding specific sections of Notion content from the rendered webpage by wrapping them in `<hide>` and `</hide>` tags within the Notion page's text blocks. This is processed after the HTML is generated.
    *   **Example Use Case:** If you provide navigation to subpages within a table or main text, you can hide the default list of subpage links (generated from Notion's `child_page` blocks) by placing `<hide>` before the first child page block and `</hide>` after the last one in your Notion document.
*   **Password Protection**: Allows protecting specific sections of Notion content with a password. Wrap the content in `<pass>` and `</pass>` tags within the Notion page's text blocks. Users will be prompted for a password (configurable via `CONTENT_PASSWORD` environment variable or in `private/config.php`) to view the content. Security features include:
    *   CSRF protection with cryptographic tokens
    *   Brute-force protection (3 attempts, 5-minute lockout)
    *   Secure session cookies (HttpOnly, Secure, SameSite=Lax)
    *   Session timeout after 15 minutes of inactivity
*   **Basic Error Handling**: Includes a simple `error.php` page for 404 and 500 errors.
*   **Simple Setup**: Requires minimal configuration.

## Project Structure

```text
.
├── private/
│   ├── cache/          # Cache directory (the script will attempt to create it if it doesn't exist, but write permissions for the web server are required for the `private/` directory)
│   ├── config.php      # Configuration file (API key, page ID, cache, password) - **DO NOT COMMIT**
│   ├── config_draft.php # Example configuration file / template
│   ├── notion_utils.php # Utility functions for Notion API interaction, caching, and HTML rendering
│   ├── security_headers.php # Security headers configuration (CSP, HSTS, X-Frame-Options, etc.)
│   └── views/
│       └── main_template.php # Main HTML template for the page structure
├── public_html/
│   ├── css/
│   │   └── style.css   # Main stylesheet
│   ├── js/
│   │   └── main.js     # Main JavaScript file (TOC, lightbox)
│   ├── .htaccess       # Apache configuration (URL rewriting for hierarchical routing, SetEnv, cache, errors)
│   ├── index.php       # Main application file: handles routing, includes configuration and utilities, orchestrates data fetching and passes it to the template.
│   ├── image.php       # Image proxy with local cache for Notion images
│   ├── error.php       # Simple error page handler
│   └── robots.txt      # Instructions for web crawlers and AI bots
├── .gitignore          # Specifies intentionally untracked files for Git
├── .debug              # Create this empty file to enable debug mode (not committed)
└── README.md           # This documentation file
```

## Setup

1.  **Clone the repository:**
    ```bash
    git clone <your-repository-url>
    cd <repository-directory>
    ```
2.  **Configure API Key:** Choose **one** of the following methods:
    *   **Method 1 (Recommended: Environment Variable):** Set the `NOTION_API_KEY` environment variable on your server (e.g., via hosting panel or `SetEnv` in `.htaccess`).
    *   **Method 2 (Alternative: Direct Edit - Less Secure):** Edit `private/config.php` and assign your key to `$notionApiKey` within the `if` block. **Ensure `private/config.php` is in `.gitignore`.**
3.  **Configure Notion Page ID:** Edit `private/config.php` and set `$notionPageId` to your main Notion page ID.
4.  **Configure Content Password (Optional):** If you plan to use the `<pass>` tag feature:
    *   **Method 1 (Recommended: Environment Variable):** Set the `CONTENT_PASSWORD` environment variable on your server.
    *   **Method 2 (Alternative: Direct Edit):** Edit `private/config.php` and set `$contentPassword` to a strong password.
5.  **Configure Cache:**
    *   Ensure `private/cache/` exists and is writable by the web server (the script will attempt to create the `cache/` directory if it doesn't exist, but write permissions for the web server are still needed for the parent `private/` directory).
    *   Edit `private/config.php` and adjust the values in the `$cacheDurations` array to set appropriate cache lifetimes (in seconds) for `'content'`, `'pagedata'`, `'subpages'`, and `'mentions'`. For example, page content might be cached for an hour (`3600`), page metadata for 2 hours (`7200`), subpage lists for a day (`86400`), and page mentions for a week (`604800`).
6.  **Web Server Configuration (Apache):** Ensure `.htaccess` overrides are allowed (`AllowOverride All`) and `mod_rewrite` / `mod_env` are enabled. PHP sessions must also be enabled.
7.  **(Optional) Review `public_html/robots.txt`:** The default file blocks most indexing. Adjust if you have different requirements (not recommended if the content mirrors Notion directly).
8.  **(Optional) Enable Debug Mode:** Create an empty `.debug` file in the project root to enable PHP error display. This is useful during development. Remove or rename the file for production.
9.  **Access the site:** Navigate to the root directory corresponding to `public_html` in your browser.

## Dependencies

*   PHP (tested on 7.x/8.x, requires `curl` extension, session support)
*   Web server (Apache with `mod_rewrite`, `mod_env` recommended)
*   Notion API Key (uses API version `2025-09-03`)

## Front-end Libraries (via CDN)

*   [Prism.js](https://prismjs.com/): For syntax highlighting.
*   [KaTeX](https://katex.org/): For rendering mathematical equations.

## Limitations / Known Issues

*   **Performance with Page Mentions**: Fetching titles for many unique page mentions can be slow.
*   **Limited Block Support**: Complex blocks like databases are not supported.
*   **Deeply Nested Blocks**: May not render perfectly.
*   **URL Normalization**: Basic title-to-URL conversion (including for nested paths) might have edge cases, especially with complex page titles or very deep nesting.
*   **No Real-time Updates**: Content updates rely on cache expiration.
*   **Security**: Password protection includes CSRF tokens, brute-force protection, and secure session handling. While suitable for most use cases, avoid storing highly confidential information.